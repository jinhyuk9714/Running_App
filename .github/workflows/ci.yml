name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

# ë™ì¼ ë¸Œëžœì¹˜ì—ì„œ ìƒˆ push ì‹œ ì´ì „ workflow ì·¨ì†Œ
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  JAVA_VERSION: '17'
  NODE_VERSION: '20'
  DOCKER_IMAGE: running-app

jobs:
  # ==========================================================================
  # Backend Build & Test
  # ==========================================================================
  build-backend:
    name: Backend Build & Test
    runs-on: ubuntu-latest
    outputs:
      build_time: ${{ steps.build-time.outputs.duration }}
      test_count: ${{ steps.test-results.outputs.count }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      # Gradle ìºì‹œ (ì˜ì¡´ì„± + ë¹Œë“œ ìºì‹œ)
      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            .gradle
            build/classes
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # ë¹Œë“œ ì‹œê°„ ì¸¡ì • ì‹œìž‘
      - name: Record build start time
        id: build-start
        run: echo "start=$(date +%s)" >> $GITHUB_OUTPUT

      # í…ŒìŠ¤íŠ¸ ë³‘ë ¬ ì‹¤í–‰ (maxParallelForks)
      - name: Build and Test
        run: |
          ./gradlew build jacocoTestReport --no-daemon --parallel \
            -Dorg.gradle.workers.max=4
        env:
          GRADLE_OPTS: '-Xmx2g -XX:+UseParallelGC'

      # ë¹Œë“œ ì‹œê°„ ì¸¡ì • ì¢…ë£Œ
      - name: Calculate build duration
        id: build-time
        run: |
          end=$(date +%s)
          start=${{ steps.build-start.outputs.start }}
          duration=$((end - start))
          echo "duration=${duration}s" >> $GITHUB_OUTPUT
          echo "::notice::Build completed in ${duration} seconds"

      # í…ŒìŠ¤íŠ¸ ê²°ê³¼ íŒŒì‹±
      - name: Parse test results
        id: test-results
        if: always()
        run: |
          if [ -f build/test-results/test/*.xml ]; then
            count=$(grep -h "tests=" build/test-results/test/*.xml | grep -oP 'tests="\K[0-9]+' | head -1)
            echo "count=${count:-0}" >> $GITHUB_OUTPUT
          else
            echo "count=0" >> $GITHUB_OUTPUT
          fi

      # í…ŒìŠ¤íŠ¸ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: build/test-results/test/
          retention-days: 7

      # JaCoCo ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: coverage-report
          path: build/reports/jacoco/test/html/
          retention-days: 7

      # PRì— ì»¤ë²„ë¦¬ì§€ ì½”ë©˜íŠ¸ ì¶”ê°€
      - name: Add coverage to PR
        uses: madrapps/jacoco-report@v1.6.1
        if: github.event_name == 'pull_request'
        with:
          paths: build/reports/jacoco/test/jacocoTestReport.xml
          token: ${{ secrets.GITHUB_TOKEN }}
          min-coverage-overall: 60
          min-coverage-changed-files: 70
          title: 'ðŸ“Š í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸'

      # JAR ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: backend-jar
          path: build/libs/*.jar
          retention-days: 3

  # ==========================================================================
  # Frontend Build
  # ==========================================================================
  build-frontend:
    name: Frontend Build
    runs-on: ubuntu-latest
    outputs:
      build_time: ${{ steps.build-time.outputs.duration }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Record build start time
        id: build-start
        run: echo "start=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Install dependencies
        run: npm ci
        working-directory: frontend

      - name: Build frontend
        run: npm run build
        working-directory: frontend

      - name: Calculate build duration
        id: build-time
        run: |
          end=$(date +%s)
          start=${{ steps.build-start.outputs.start }}
          duration=$((end - start))
          echo "duration=${duration}s" >> $GITHUB_OUTPUT
          echo "::notice::Frontend build completed in ${duration} seconds"

      - name: Upload frontend artifact
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: frontend-dist
          path: frontend/dist
          retention-days: 3

  # ==========================================================================
  # Docker Build
  # ==========================================================================
  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: build-backend
    outputs:
      image_size: ${{ steps.image-size.outputs.size }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Docker ë ˆì´ì–´ ìºì‹œ
      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: docker-${{ runner.os }}-${{ hashFiles('Dockerfile', 'build.gradle.kts') }}
          restore-keys: |
            docker-${{ runner.os }}-

      # ì´ë¯¸ì§€ íƒœê·¸ ìƒì„± (ë²„ì „ + SHA)
      - name: Generate image tags
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_IMAGE }}
          tags: |
            type=ref,event=branch
            type=sha,prefix=
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

      - name: Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max
          outputs: type=docker,dest=/tmp/image.tar

      # ì´ë¯¸ì§€ í¬ê¸° ì¸¡ì •
      - name: Measure image size
        id: image-size
        run: |
          size=$(du -h /tmp/image.tar | cut -f1)
          echo "size=${size}" >> $GITHUB_OUTPUT
          echo "::notice::Docker image size: ${size}"

      # ìºì‹œ ì •ë¦¬ (ìºì‹œ í¬ê¸° ë¬´í•œ ì¦ê°€ ë°©ì§€)
      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

  # ==========================================================================
  # Build Summary
  # ==========================================================================
  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend, docker]
    if: always()

    steps:
      - name: Create summary
        run: |
          echo "## ðŸƒ Running App CI/CD Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status | Duration |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ needs.build-backend.result == 'success' && 'âœ…' || 'âŒ' }} | ${{ needs.build-backend.outputs.build_time || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ needs.build-frontend.result == 'success' && 'âœ…' || 'âŒ' }} | ${{ needs.build-frontend.outputs.build_time || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker | ${{ needs.docker.result == 'success' && 'âœ…' || 'âŒ' }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Metrics" >> $GITHUB_STEP_SUMMARY
          echo "- **Tests**: ${{ needs.build-backend.outputs.test_count || '0' }} tests" >> $GITHUB_STEP_SUMMARY
          echo "- **Docker Image**: ${{ needs.docker.outputs.image_size || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Commit: ${{ github.sha }}*" >> $GITHUB_STEP_SUMMARY

  # ==========================================================================
  # Deploy to Production
  # ==========================================================================
  deploy:
    name: Deploy to NCP
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production

    steps:
      - name: Download backend JAR
        uses: actions/download-artifact@v4
        with:
          name: backend-jar
          path: backend

      - name: Download frontend dist
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: frontend-dist

      - name: Set up SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

      - name: Add server to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy backend
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
        run: |
          JAR=$(find backend -name "*.jar" -type f ! -name "*-plain.jar" | head -1)
          if [ -z "$JAR" ]; then echo "::error::JAR not found"; exit 1; fi
          echo "::notice::Deploying backend: $JAR"
          scp -o StrictHostKeyChecking=no "$JAR" $DEPLOY_USER@$DEPLOY_HOST:~/app.jar
          ssh -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_HOST 'sudo systemctl restart running-app'

      - name: Deploy frontend
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
        run: |
          echo "::notice::Deploying frontend..."
          scp -o StrictHostKeyChecking=no -r frontend-dist/* $DEPLOY_USER@$DEPLOY_HOST:/var/www/html/
          echo "::notice::Frontend deployed successfully"

      - name: Health check
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
        continue-on-error: true
        run: |
          echo "Waiting for application to start..."
          sleep 45

          HEALTH_URL="https://$DEPLOY_HOST/actuator/health"
          echo "Health check URL: $HEALTH_URL"

          for i in {1..5}; do
            echo "Attempt $i/5..."

            # curl with timeout, verbose output on failure
            HTTP_CODE=$(curl -s -o /tmp/health_response.txt -w "%{http_code}" \
              --connect-timeout 10 \
              --max-time 30 \
              "$HEALTH_URL" 2>&1) || true

            echo "HTTP Status: $HTTP_CODE"

            if [ "$HTTP_CODE" = "200" ]; then
              echo "::notice::Health check passed! (HTTP $HTTP_CODE)"
              cat /tmp/health_response.txt
              exit 0
            fi

            # Show response for debugging
            if [ -f /tmp/health_response.txt ]; then
              echo "Response body:"
              cat /tmp/health_response.txt || true
            fi

            if [ $i -lt 5 ]; then
              echo "Retrying in 15s..."
              sleep 15
            fi
          done

          echo "::warning::Health check failed after 5 attempts (HTTP $HTTP_CODE)"
          echo "Note: Application may still be starting. Check server logs for details."

      - name: Create deployment summary
        if: success()
        run: |
          echo "## ðŸš€ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: Production" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Time**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Links" >> $GITHUB_STEP_SUMMARY
          echo "- [Swagger UI](https://${{ secrets.DEPLOY_HOST }}/swagger-ui/index.html)" >> $GITHUB_STEP_SUMMARY
          echo "- [Health Check](https://${{ secrets.DEPLOY_HOST }}/actuator/health)" >> $GITHUB_STEP_SUMMARY
